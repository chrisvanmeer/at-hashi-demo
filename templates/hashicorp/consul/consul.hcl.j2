datacenter = "{{ hashicorp_datacenter_name }}"
data_dir = "{{ consul_data_directory }}"
encrypt = "{{ consul_ecryption_key }}"
ca_file = "{{ consul_etc_directory }}/consul-agent-ca.pem"
{% if ansible_hostname in groups['servers'] %}
{% set type = "server" %}
{% elif ansible_hostname in groups['clients'] %}
{% set type = "client" %}
{% endif %}
cert_file = "{{ consul_etc_directory }}/{{ hashicorp_datacenter_name }}-{{ type }}-consul-0.pem"
key_file = "{{ consul_etc_directory }}/{{ hashicorp_datacenter_name }}-{{ type }}-consul-0-key.pem"
verify_incoming = false
verify_outgoing = false
verify_server_hostname = false
retry_join = ["{{ consul_retry_join_address }}"]
{% if ansible_hostname in groups['servers'] %}
bind_addr = "0.0.0.0"
client_addr = "0.0.0.0"
ui = true
{% elif ansible_hostname in groups['clients'] %}
bind_addr = "{{ ansible_host }}"
check_update_interval = "0s"
{% endif %}

acl = {
  enabled = true
  default_policy = "allow"
  enable_token_persistence = true
}

performance {
  raft_multiplier = 1
}

{% if ansible_hostname in groups['servers'] %}
server = true
bootstrap_expect = {{ hashicorp_bootstrap_expect }}
{% elif ansible_hostname in groups['clients'] %}
server = false
{% endif %}
rejoin_after_leave = true

ports {
  grpc = 8502
}

connect {
  enabled = true
}
